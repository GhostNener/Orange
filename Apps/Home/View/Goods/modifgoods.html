<extend name="./Tpl/layout.html"/>
<block name="content">
	<div id="main" class="container">
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="board">
					<div class="board-inner">
						<!-- 导航 -->
						<ul class="nav nav-tabs" id="myTab">
							<div class="liner"></div>
							<li class="active">
								<a href="#step1" data-toggle="tab" title="基本信息" >
									<span class="round-tabs four"> <i class="glyphicon glyphicon-camera"></i>
									</span>
								</a>
							</li>

							<li>
								<a href="#step2" data-toggle="tab" title="选填内容">
									<span class="round-tabs two"> <i class="glyphicon glyphicon-pencil"></i>
									</span>
								</a>
							</li>
							<li>
								<a href="#step3" data-toggle="tab" title="增值服务">
									<span class="round-tabs three">
										<i class="glyphicon glyphicon-gift"></i>
									</span>
								</a>
							</li>
							<li>
								<a href="#step4" data-toggle="tab" title="确认发布">
									<span class="round-tabs one">
										<i class="glyphicon glyphicon-ok"></i>
									</span>
								</a>
							</li>

						</ul>
					</div>
					<!-- 表单内容 -->
					<form class="form-horizontal"  role="form" method="post" >
						<div class="tab-content">

							<!-- 必填内容 -->
							<div class="tab-pane fade in active" id="step1">
								<input type="hidden" id="GoodsId" name="GoodsId" value="0">
								<input type="hidden" class="form-control " id="imgcount" name="imgcount" value="0" Readonly>
								<input type="hidden" class="form-control " id="url"	publicurl="__PUBLIC__" appurl="__URL__" rooturl="__ROOT__" gid="0" saveurl="{:U('Home/Goods/save')}" urlindex="{:U('Home/Goods/index')}" Readonly>
								<input type="hidden" class="form-control " id="keyid" name="keyid" value="0" Readonly>
								<div class="form-group">
									<label for="Title" class="col-sm-3 control-label">标题</label>
									<div class="col-sm-8">
										<input type="text" id="Title" name="Title" class="form-control" placeholder="输入商品名字、成色"></div>
								</div>
								<div class="form-group">
									<label for="CostPrice" class="col-sm-3 control-label">原价</label>
									<div class="col-sm-3">
										<div class="input-group">
											<input type="text" id="CostPrice" name="CostPrice" class="form-control" placeholder="商品原价">
											<span class="input-group-addon">.00</span>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="Price" class="col-sm-3 control-label">转卖价</label>
									<div class="col-sm-3">
										<div class="input-group">
											<input type="text" id="Price" name="Price" class="form-control" placeholder="你要卖的价格">
											<span class="input-group-addon">.00</span>
										</div>
									</div>
								</div>
								<div class="form-group">
									<label for="TradeWay" class="col-sm-3 control-label">交易方式</label>
									<div class="col-sm-3">
										<div class="btn-group" data-toggle="buttons" >
											<label class="btn btn-default btn-expend active" data-toggle="tooltip" data-placement="bottom" title="买家用“金橘”作为货币交易" data-container="body">
												<input type="radio" name="TradeWay" value="1"  autocomplete="off" checked>线上</label>
											<label class="btn btn-default btn-expend"  data-toggle="tooltip" data-placement="bottom" title="现金交易" data-container="body">
												<input type="radio" name="TradeWay"   value="2" autocomplete="off">线下</label>
											<label class="btn btn-default btn-expend" data-toggle="tooltip" data-placement="bottom" title="由买家选择交易方式" data-container="body">
												<input type="radio" name="TradeWay"  value="3" autocomplete="off">线上/线下</label>
										</div>
									</div>
								</div>

								<div class="form-group">
									<label for="AddressId" class="col-sm-3 control-label">发货联系人</label>
									<div class="col-sm-5">
										<div class="input-group">
											<select class="form-control" id="AddressId" name="AddressId">
												<foreach name="alist" item="v">
													<option value="{$v['Id']}" address="{$v['Address']}" Contacts="{$v['Contacts']}">
														{$v['Contacts']}&nbsp;&nbsp;{$v['Tel']}&nbsp;&nbsp;{$v['Address']}
													</option>
												</foreach>
											</select>
											<span class="input-group-btn">

												<a id="refreshadd" class="btn btn-default btn-expend" data-toggle="tooltip" data-placement="top" title="刷新地址" data-container="body">
													<span class="glyphicon glyphicon-refresh"></span>
												</a>
												<a  href="{:U('Usercenter/Address/addaddress')}" target="_blank" class="btn btn-default btn-expend" data-toggle="tooltip" data-placement="top" title="添加新地址" data-container="body">
													<span class="glyphicon glyphicon-plus"></span>
												</a>
											</span>
										</div>
									</div>
								</div>

								<div class="form-group">
									<label for="file_upload" class="col-sm-3 control-label">商品照片</label>
									<div class="col-sm-9">
										<input id="file_upload" name="file_upload" type="file" class="btn btn-success" multiple="true"></input>
									<div id="image" class=" col-sm-10"></div>
								</div>
							</div>

							<a href="#step2" class="btn btn-danger btn-outline-rounded green active-step pull-right">
								选填内容&nbsp
								<span class="glyphicon glyphicon-chevron-right"></span>
							</a>
						</div>

						<!-- 选填内容 -->
						<div class="tab-pane fade" id="step2">

							<div class="form-group">
								<label for="CategoryId" class="col-sm-3 control-label">商品分类</label>
								<div class="col-sm-5">
									<select class="form-control" id="CategoryId" name="CategoryId">
										<foreach name="clist" item="v">
											<option value="{$v['Id']}">{$v['Title']}</option>
										</foreach>
									</select>

								</div>
							</div>

							<div class="form-group">
								<label for="Presentation" class="col-sm-3 control-label">商品描述</label>
								<div class="col-sm-8">
									<textarea class="form-control" id="Presentation" name="Presentation" rows="3" placeholder="详细描述商品信息（选填）"></textarea>
								</div>
							</div>

							<a href="#step1" class="btn btn-primary btn-outline-rounded green active-step">
								<span class="glyphicon glyphicon-chevron-left"></span>
								&nbsp基本信息
							</a>
							<a href="#step3" class="btn btn-orange btn-outline-rounded green active-step pull-right">
								增值服务&nbsp
								<span class="glyphicon glyphicon-chevron-right"></span>
							</a>
						</div>

						<!-- 服务 -->
						<div class="tab-pane fade" id="step3">
							<div class="row">
								<foreach name="slist" item="v">
									<!-- 一个服务 -->
									<div class="col-sm-4 col-lg-4 col-md-4 serverdiv">
										<label  style="width:100%">
											<div class="checkbox servercheckbox">
												<input type="checkbox" class="hidden Serverc" name="Server" value="{$v['Id']}"     >
												<div class="thumbnail">
													<h3 class="text-center">{$v['Title']}</h3>
													<hr/>
													<div class="caption">
														<p style="font-weight: 400;">{$v['Presentation']}</p>
													</div>
													<hr/>
													<h4 class="text-right text-p">
														<span class="glyphicon glyphicon-ok pull-left text-success serverok"></span>
														费用:&nbsp
														<span class="importinfo">{$v['Price']}.00</span>
													</h4>
												</div>
											</div>
										</label>
									</div>
									<!--一个服务结束-->
								</foreach>

							</div>

							<!-- 服务为空的时候 -->
							<!-- <h3 class="text-center text-import">暂不提供服务</h3>
						-->
						<a href="#step2" class="btn btn-danger btn-outline-rounded green active-step">
							<span class="glyphicon glyphicon-chevron-left"></span>
							&nbsp增值服务
						</a>
						<a href="#step4" class="btn btn-success btn-outline-rounded green active-step pull-right">
							支付佣金&nbsp
							<span class="glyphicon glyphicon-chevron-right"></span>
						</a>
					</div>
					<div class="tab-pane fade" id="step4">
						<h3 class="text-center text-import">
							金橘余额:&nbsp
							<span class="importinfo">80</span>
						</h3>

						<h3 class="text-center text-import">
							共需支付:&nbsp
							<span class="importinfo">9999</span>
						</h3>
						<!-- 积分不足时候显示 -->
						<p class="text-center text-import">
							<button class="btn btn-danger">余额不足请充值</button>
						</p>

						<a id="submitsave" class="btn btn-success btn-outline-rounded green active-step pull-right">
							付款并发布&nbsp
							<span class="glyphicon glyphicon-send"></span>
						</a>
					</div>
					<div class="clearfix"></div>
				</div>

			</form>
		</div>
	</div>
</div>
</block>
<block name="js">

<script src="__PUBLIC__/js/jquery.uploadify.min.js?{:time()}"></script>
<link rel="stylesheet" href="__PUBLIC__/css/uploadify.css">
<script type="text/javascript">
	/*删除图片  第一个参数为图片父控件的Id  第二个参数为图片相对路径*/
	function del(div_id,imgId){
    	var _pdivid='#'+div_id;
		var _url=$('#url').attr('appurl')+'/delimg';		
         $.post(_url,{'Id':parseInt(imgId)},function(data){		
        	 if(data.info==1){
        		 $(_pdivid).html(data.info);
        		 $(_pdivid).remove();	
                 var _imgcount=parseInt($('#imgcount').val());
                 if((_imgcount-1)<=0){
                	 _imgcount=0;
                 }else{_imgcount=_imgcount-1;}
                 $('#imgcount').val((_imgcount));
        	 }else{
        		 alert("删除失败\n"+data.info);
        	 }
        },'json');	
	}
		$(document).ready(function(){
				$('.servercheckbox').click(function(e){
					var _ch=$(this).children("input[name='Server']").attr('checked');
					if(!_ch){
						$(this).children('.thumbnail').css('border-color','#DDD');
						$(this).children('.thumbnail').children('h4').children().first().addClass('serverok');
					}else {
						$(this).children('.thumbnail').css('border-color','#FA7D3C');
						$(this).children('.thumbnail').children('h4').children().removeClass('serverok');
					
					}
				});



				$('#file_upload').uploadify({
			'fileTypeDesc' : 'Image Files',	
			'overrideEvents': [ 'onSelectError' ],	
			'formData'  : {'sname':'{$sname}','sid':'{$sid}',                    
			'cid' : '{$cid}',
			'ckey' : '{$ckey}'},/*FF302解决参数*/			
			//'removeCompleted' : false,    //是否自动消失
       		'fileTypeExts' : '*.gif; *.jpg; *.png',		//允许类型
       		'fileSizeLimit' : '4MB',					//允许上传最大值
			'swf'      : $('#url').attr('publicurl')+'/Img/uploadify.swf',	//加载swf
			'uploader' : $('#url').attr('appurl')+'/uploadify',					//上传路径
			'buttonText' :'+',	
			'uploadLimit':30,
			'queueSizeLimi':5,
			'height':40,
			'width':40,
			'debug':false,
			'preventCaching':true,/*防止缓存*/
			'fileObjName ':'Filedata',/*File数组参数名*/
			'progressData':'percentage',
			'removeTimeout':0,
			'onSelectError':function(file, errorCode, errorMsg){  
				var msgText = "上传失败\n";
                switch(errorCode) {  
                    case -100:  
                        msgText += "每次最多上传 " + this.settings.queueSizeLimit + "个文件";;  
                        break;  
                    case -110:  
                        msgText += "文件大小超过限制( " + this.settings.fileSizeLimit + " )"; 
                        break;  
                    case -120:  
                      msgText += "文件["+file.name+"]大小为0"; 
                        break;  
                    case -130:  
                         msgText += "文件["+file.name+"]格式不正确，仅限 " + this.settings.fileTypeExts;
                        break;  
                    default:
              		    msgText += "错误代码：" + errorCode + "\n" + errorMsg;
                } 
                alert(msgText); 
            },


			'onUploadSuccess' : function(file, data, response) {
				if(!data){alert('上传失败！');
				return;
			}
			data=$.parseJSON(data);
			/*data[0] 图片ID*/
			/*data[1] 图片相对url*/
			if(!($.isNumeric(data[0]))||!data[0]){
				alert("上传失败！\n"+data[1]);
				return;
			}
			var _gid=$('#url').attr('gid');
			var _postimgurl=$('#url').attr('appurl')+'/saveimg';
			$.post(_postimgurl,{
				'_imgid':data[0],
				'_gid':_gid
			},function(datainfo){
				if(parseInt(datainfo.status)==1){
					/*成功上传返回*/
					$('#url').attr('gid',datainfo.info);
					var _imgId='_'+(parseInt(Math.random() *100)+(new Date()).valueOf());
					var _tempPath=$('#url').attr('rooturl');
					/*插入到image标签内，显示图片的缩略图 */
					$('#image').append('<div id="'+_imgId+'" class="photo" style="float: left; margin-right: 3px;margin-left: 3px" ><img src="'+_tempPath+data[1]+'"  height=100 width=100 /><div class="del" style="text-align: center;"><a class="a_imgdel" href="javascript:void(0)"onclick=del("'+_imgId+'","'+data[0]+'");return false; imgurl="'+data[1]+'">删除</a></div></div>');
					var _imgcount=parseInt($('#imgcount').val());
					$('#imgcount').val((_imgcount+1));
						return;
					}else{
						alert('上传失败！');
						return;
					}
				});
			}
		});
	});
	$(document).ready(function () {
		/*刷新地址*/
		$('#refreshadd').click(function(e){
			var _url=$('#url').attr('appurl')+'/refreshadd';
			$.post(_url,{'':''},function(data){
				if(data.status==1){
					if(!data.info){return;}
					var _arr=$.parseJSON(data.info);
					if(!_arr){return;}
					$('#Address').children('option').remove();
					$(_arr).each(function(i,v){
						$('#Address').append("<option value="+v['Id']+" address="+v['address']+" >"+v['Tel']+"&nbsp;&nbsp;"+v['Address']+"</option>");
					});
					return;
				}
			});		
		});
    	/*标题焦点离开事件  获取分类*/
    	$('#Title').blur(function(e){
    		var _Title=$.trim($('#Title').val());
    		if(!_Title){
    			return;
    		}
    		$.post($('#url').attr('appurl')+'/getcategory',{
    			'Title':_Title
    		},function(data){
    			/*收索失败*/
    			if(data.status==0||!data.status){
    				var _arr=$.parseJSON(data.info);
    				/*新的关键字*/
    				if(_arr[1]>1||parseInt(_arr[1])>1){
    					$('#keyid').val(_arr[1]);
    				}
    				return;
    			}
    			/*搜索成功 返回结果*/
    			if(data.status==1||data.status){
    				var _arr=$.parseJSON(data.info);
    				/*返回一个结果的时候 选中返回项*/
    				if(parseInt(_arr[0])==1){
    					$('#Category').children('option').each(function(){
    						if(parseInt($(this).val())==parseInt(_arr[1])){
    							$(this).attr('selected',true);
    						}
    					});
    					$('#keyid').val(0);
    					return;
    				}
    				/*返回多个结果  需要先清空 下拉列表 然后重新生成  生成按搜索顺序+剩下的分类顺序  木人选中第一项*/
    				if(parseInt(_arr[0])==2){
    					var _arr=$.parseJSON(data.info);
    					$('#Category').children('option').remove();
    					$(_arr[1]).each(function(i,v){
    						$('#Category').append("<option value="+v['Id']+">"+v['Title']+"</option>");
    					});
    					$('#keyid').val(0);
    					return;
    				}
    			}
    		},'json');});
		/*提交按钮*/
    	$('#submitsave').click(function(e){

    	/*	判断是否填写的title*/
    		var _Title=$.trim($('#Title').val());
    		if(!_Title){

    			return;
    		}
    		/*判断是否填写价格*/
    		var _Price=$.trim($('#Price').val());
    		if(!$.isNumeric(_Price)||parseInt(_Price)<=0||parseInt(_Price)>99999){
    			$('#Price').val('');
    			$('#Price').focus();
    			return;
    		}
    		/*判断是否填写原价*/
    		var _CostPrice=$.trim($('#CostPrice').val());
    		if(!$.isNumeric(_CostPrice)||parseInt(_CostPrice)<=0||parseInt(_CostPrice)>99999){
    			$('#CostPrice').val('');
    			$('#CostPrice').focus();
    			return;
    		}
    		if(parseInt(_CostPrice)<parseInt(_Price)){
    			$('#Price').focus();
    			return;
    		}
    		/*简介*/
    		var _Presentation=$.trim($('#Presentation').val());
    		var _keyid=$('#keyid').val();
    		/*分类*/
    		var _Category=$('#Category').val();
    		var _Address=$('#AddressId').val();
    		if(!$.isNumeric(_Address)||parseInt(_Address)<=0){
    			$('#Address').focus();
    			return;
    		}
    		$('#AddressId').children('option').each(function(){    			
    			var tempadd=$.trim($(this).attr('address'));
    			var tempval=parseInt($(this).val());
    			if(tempval==parseInt(_Address)){
    				if(!tempadd){
    					alert("所选的地址为空！");
    					_Address=0;
    					$('#AddressId').focus();
    					return;
    				}
    			}
    		});
    		if(!_Address){
    			$('#Address').focus();
    			return;
    		}
    		$('#GoodsId').val($('#url').attr('gid'));
    		var _TradeWay=$('#TradeWay').val();  		
    		    		/*判断是否传了图*/
    		var _imgcount=$('#imgcount').val();
    		if(parseInt(_imgcount)<=0){
    			alert('至少上传一张图片！');
    			return;
    		}
    		var btn_txt=$(this).val();
    		$(this).attr('disabled',"true");
    		$(this).val('....');
    		$.post($('#url').attr('saveurl'),{
    			'GoodsId':_GoodsId,
    			'imgcount':_imgcount,
    			'Title':_Title,
    			'Price':_Price,
    			'CostPrice':_CostPrice,
    			'Presentation':_Presentation,
    			'CategoryId':_Category,
    			'AddressId':_Address,
    			'TradeWay':_TradeWay,
    			'Server':_Server,
    			'keyid':_keyid
    		},function(data){
    			if(data.info==1){
    				/*alert('Ok!');*/
    				location.href=$('#url').attr('urlindex');
    			}else{
    				alert(data.info);
    			}
    		});
    		$(this).val(btn_txt);
    		$(this).removeAttr('disabled');   		  		
    	});
    })
</script></block>

<block name="css">

<style>
	div.checkbox{

		cursor: pointer;
	}
	.serverok{
		color: #fff;
	}
	.isok{
		color: #ccc;
	}

</style>

</block>

<block name="login">
<if condition="$usermodel eq null">
	<ul class="nav navbar-nav navbar-right">
		<li>
			<a href="{:U('Usercenter/User/index')}" >登录</a>
		</li>
		<li>
			<a href="{:U('Usercenter/User/regist')}">注册</a>
		</li>
	</ul>
	<else/>
	<!-- 登录状态 -->
	<ul class="nav navbar-nav navbar-right nickul">
		<li class="dropdown">
			<a class="dropdown-toggle" data-toggle="dropdown" href="#">
				<img src="http://hhhhold.com/18x18" class="nicknameimg">
				<span class="nickname">&nbsp;如果汉字的长2的长字的长度太</span>
				&nbsp
				<span class="caret"></span>
				&nbsp
				<span class="badge">3</span>
			</a>
			<ul class="dropdown-menu">
				<li>
					<a href="#">
						<span class="badge pull-right">3</span>
						未读消息
					</a>
				</li>
				<li>
					<a href="#">个人中心</a>
				</li>
				<li>
					<a href="#">心愿单</a>
				</li>
				<li>
					<a href="#">充值</a>
				</li>
				<li class="divider"></li>
				<li>
					<a href="#">退出用户</a>
				</li>
			</ul>
		</li>
	</ul>
</if>
</block>