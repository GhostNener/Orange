<extend name="./Tpl/layout.html"/>
<block name="content">
	<div id="main" class="container">
		<div class="col-md-6 col-md-offset-3">
			<div class="panel panel-default login-panel">
				<div class="panel-body">
					<div id="errormsg" class="alert alert-danger text-center errormsg"  role="alert">用户名或密码错误</div>
					<form class="form-horizontal" role="form" method="post" action="{:U('Usercenter/User/login')}">
						<div class="modal-body">
							<div class="form-group">
								<input type="hidden" id="isadmin" name="isadmin" value="{$admin}">
								<label for="UserName" class="col-sm-2 control-label">用户名</label>
								<div class="col-sm-10">
									<input type="text" name="UserName" id="UserName" class="form-control" placeholder="邮箱/手机号" ></div>
							</div>
							<div class="form-group">
								<label for="Password" class="col-sm-2 control-label">密&nbsp&nbsp&nbsp&nbsp码</label>
								<div class="col-sm-10">
									<input type="password" name="Password" id="Password" class="form-control" ></div>
							</div>
							<div class="form-group">
								<label for="verifycode" class="col-sm-2 control-label">验证码</label>
								<div class="col-sm-10">
									<input type="text" class="form-control" id="verifycode"></div>
							</div>
							<div class="form-group">
								<div class="col-sm-offset-2 col-sm-10">
									<img class="verifycode" src="{:U('Usercenter/Public/verifycode')}" alt="点击刷新" title="点击刷新"></div>
							</div>
							<input type="hidden" id="url" value="0" getcode="{:U('Public/verifycode')}" checkcode="{:U('Usercenter/Public/check_verify')}" login="{:U('Usercenter/User/login')}" home="{:U('Home/Index/index')}" >
							<input type="hidden" value="0" name="isremeber"  id="isremeber">
							<div class="form-group">
								<div class="col-sm-offset-2 col-sm-10">
									<if condition=" ($admin neq 1) AND ($admin neq true)">
										<div class="checkbox">
											<label>
												<input id="rememberme" type="checkbox" >&nbsp;请记住我（30天）</label>
										</div>
									</if>

								</div>
							</div>
						</div>
						<div class="modal-footer">
							<a href="#">忘记密码？</a>
							<button type="button" id="loginbutton" class="btn btn-success" >登录</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</block>
<block name="css">
	<style>
img.verifycode{
	cursor: pointer;
}
	</style>
</block>

<block name="js">
	<script>
	$(function(){
		function showmsg(msg,intime=500,outtime=1000){
			$('#errormsg').stop(true);
			$('#errormsg').html(msg);
			$('#errormsg').fadeIn(intime);
			$('#errormsg').fadeOut(outtime);
		}
		/*验证码自动验证*/
/*		$('#verifycode').blur(function(){
			var _code=$.trim($(this).val());
			if(!_code){return;}
			$.post($('#url').attr('checkcode'),{'code':_code},function(data){
				if(!data){
					$('#verifycode').parent().removeClass('has-error');
					$('#verifycode').parent().addClass('has-error');
					$('#verifycode').attr('status',0);

				}else{
					$('#verifycode').parent().removeClass('has-error');
					$('#verifycode').parent().addClass('has-success');
					$('#verifycode').attr('status',1);
				}
			});
		});*/
/*		$('#verifycode').focus(function(){
			$('#verifycode').parent().removeClass('has-error');
		});*/
		/*登录按钮*/
		$('#loginbutton').click(function(e){
			$('#loginbutton').attr('disabled',"true");
    		$('#loginbutton').val('....');
			var _uid=$.trim($('#UserName').val());
			if(!_uid){

				showmsg('用户名为空',100,2000);
				$('#UserName').val('');
				$('#UserName').focus();
			$('#loginbutton').val(btn_txt);
    		$('#loginbutton').removeAttr('disabled'); 
				return false;
			}
			var _pwd=$('#Password').val();
			if(!$.trim(_pwd)){
				$('#Password').val('');
				$('#Password').focus();
			$('#loginbutton').val(btn_txt);
    		$('#loginbutton').removeAttr('disabled'); 
				return false;
			}
			var _isadmin=$('#isadmin').val();			
			/*记住我*/
			var _remember=parseInt($('#isremeber').val());
			var _code=$.trim($('#verifycode').val());
			/*var _status=parseInt($('#verifycode').attr('status'));*/
/*			if(!_code||!_status){
				$('#verifycode').attr('status',0);
				$('#verifycode').focus();
				return;
			}*/
			/**/
		if(!_isadmin){
			_remember=_remember;
		}else{
			_remember=0;
		}
		    var btn_txt=$('#loginbutton').val();
			/*提交表单*/
			$.post($('#url').attr('login'),{
				'Name':_uid,
				'Password':_pwd,
				'verifycode':_code,
				'isremeber':_remember,
				'isadmin':_isadmin
			},function(data){
				if(data.status==1){
					if(_isadmin){
						location.href=$('#adminrul').attr('href');
					}else{
					location.href=$('#url').attr('home');
				}
				}else{
					reloadcode();
					showmsg(data.info,100,4000);
					 reloadcode();
				}
			},'json');
    		$('#loginbutton').val(btn_txt);
    		$('#loginbutton').removeAttr('disabled'); 
		});
		/*记住我按钮*/
		$('#rememberme').click(function(e){
			var _ch=$('#rememberme').attr('checked');
			if(!_ch){

				$('#isremeber').val(0);
			}else{
		
				$('#isremeber').val(1);
			}
		});
		$('.verifycode').click(function(e){
			reloadcode();
		});
		/*刷新验证码*/
		function reloadcode(){
			var _src=$('#url').attr('getcode')+'?id='+ new Date().valueOf() ;
			$('.verifycode').attr('src',_src);
			$('#verifycode').parent().removeClass('has-error');
			$('#verifycode').parent().removeClass('has-success');
			//$('#verifycode').parent().addClass('has-error');
			$('#verifycode').attr('status',0);

		}
	});
</script>
</block>
<block name="login">
	<if condition="$usermodel eq null">
		<ul class="nav navbar-nav navbar-right">
			<li>
				<a href="{:U('Usercenter/User/index')}" >登录</a>
			</li>
			<li>
				<a href="{:U('Usercenter/User/regist')}">注册</a>
			</li>
		</ul>
		<else/>
		<!-- 登录状态 -->
		<ul class="nav navbar-nav navbar-right">
			<li class="dropdown">
				<a class="dropdown-toggle" data-toggle="dropdown" href="#">
					<img src="http://hhhhold.com/18x18">
					&nbsp{$usermodel['Nick']}&nbsp
					<span class="caret"></span>
					&nbsp
					<span class="badge">3</span>
				</a>
				<ul class="dropdown-menu">
					<li>
						<a href="#">
							<span class="badge pull-right">3</span>
							未读消息
						</a>
					</li>
					<li>
						<a href="{:U('Usercenter/UserCnter/index')}">个人中心</a>
					</li>
					<li>
						<a href="#">心愿单</a>
					</li>
					<li>
						<a href="#">充值</a>
					</li>
					<li class="divider"></li>
					<li>
						<a href="#">退出用户</a>
					</li>
				</ul>
			</li>
		</ul>
	</if>
</block>