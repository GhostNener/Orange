<extend name="./userlayout"/>
<block name="content">
<div class="col-md-9">
	<div class="panel panel-default profilemain">
		<div class="panel-body">
			<!-- Nav tabs -->
			<ul class="nav nav-tabs" role="tablist">
				<li role="presentation" class="active">
					<a href="#tab1"  role="tab" data-toggle="tab">未完成</a>
				</li>
				<li role="presentation">
					<a href="#tab2" id="buyorder" class="buyorder" role="tab" data-toggle="tab">已买商品</a>
				</li>
				<li role="presentation">
					<a href="#tab3" id="sellorder" class="sellorder" role="tab" data-toggle="tab">已售商品</a>
				</li>
			</ul>

			<!-- Tab panes -->
			<div class="tab-content">
				<div role="tabpanel" class="tab-pane active" id="tab1">

					<div class="table-responsive">
						<table class="table table-striped">
							<thead>
								<th>类型</th>
								<th>商品</th>
								<th>价格</th>
								<th style="width:100px">交易方式</th>
								<th style="width:200px">联系人</th>
								<th>状态</th>
							</thead>
							<tbody addorder>
							<foreach name="order" item="v">
								<tr class="morder">
									<td>
										<if condition="$v['BuyerId'] eq cookie('_uid')"><span class="label label-success">购买</span><else/><span class="label label-primary">出售</span></if>
									</td>
									<td>{$v['Title']} </td>
									<td>{$v['Price']}</td>
									<td>{:gettradewaytxt($v['TradeWay'])}</td>
									<td>
										{$v['BuyNick']}:{$v['Tel']}
										<br/>
										{$v['Address']}
									</td>
									<td>{:fuzhi($v)}</td>
								</tr>
							</foreach>
							</tbody>
						</table>
					</div>
					<div class="page">{$pageorder}</div>
				</div>
				
				<div role="tabpanel" class="tab-pane" id="tab2">
					<div class="table-responsive">
						<table class="table table-striped">
							<thead>
								<th>商品</th>
								<th>价格</th>
								<th width="100px">交易方式</th>
								<th>卖家</th>
								<th width="80px">评分</th>
							</thead>
							<tbody addbuy>
							</tbody>
						</table>
					</div>
					<div class="page">{$pagebuy}</div>
				</div>
				
				<div role="tabpanel" class="tab-pane" id="tab3">
					<div class="table-responsive">
						<table class="table table-striped">
							<thead>
								<th>商品</th>
								<th>价格</th>
								<th width="100px">交易方式</th>
								<th>买家</th>
								<th width="80px">评分</th>
							</thead>
							<tbody addsell>
							</tbody>
						</table>
					</div>
					<div class="page">{$pagesell}</div>
				</div>
				
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">
					<span aria-hidden="true">&times;</span>
					<span class="sr-only">Close</span>
				</button>
				<h4 class="modal-title hightlight" id="myModalLabel">请为本次交易评分</h4>
			</div>

			<form class="form-horizontal" action="{:U('u/Index/savestar')}" onsubmit="syncsubmit()" method="post" enctype="multipart/form-data">
				<div class="modal-body">

					<h1 class="row text-center">
						<div id="stars" class="starrr text-orange"></div>
						<small id="count">0</small>
						<input id="oid" type="hidden" name="oid" />
						<input id="otype" type="hidden" name="otype" />
						<input id="star" type="hidden" name="count" />
						<small>星</small>
					</h1>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-success">确定</button>
				</div>
			</form>
		</div>
	</div>
</div>
</block>

<block name="js">
<script src="__PUBLIC__/js/star.js"></script>
<script type="text/javascript">
/* 交易方式 */
function Gettradewaytxt(_wayid) {
	switch (_wayid){
		case '1' :
			return "线上";
			break;
		case '2' :
			return "线下";
			break;
		default :
			return "";
			break;
	}
}

/* 评价 */
function Star(_c){
	switch (_c){
		case '1' :
			return "★";
			break;
		case '2' :
			return "★★";
			break;
		case '3' :
			return "★★★";
			break;
		case '4' :
			return "★★★★";
			break;
		case '5' :
			return "★★★★★";
			break;
		default :
			return "";
			break;
	}
}

$(function(){
	$('.sellorder').click(function(e){
		$.ajax({
			type:'post',
			cache:false,
			url:"{:U('u/Index/sellorder')}",
			error:
			function(request)  {
	            showerrormsg('网络错误', 100, 1000);
	            return false;               
	        },
	        success:  
	        function(data){
	        	data=JSON.parse(data.info);
	        	if(data.status==1){
					if(!data){
						showerrormsg('还没出售商品呦！', 100, 1000);
						return;
					}
					$('tbody[addsell]').html('');
					var _tbody=$('tbody[addsell]');
					$(data['list']).each(function(i,v){
						 _tbody.append("<tr><td>"+v['Title']+"</td><td>"+v['Price']+"</td><td>"+Gettradewaytxt(v['TradeWay'])+"</td><td><a>"+v['BuyNick']+"</a></td><td class='text-orange'>"+Star(v['SellerStar'])+"</td></tr>");
					});
				}               
	        }
		});
		return true;
	});

	$('.buyorder').click(function(e){
		$.ajax({
			type:'post',
			cache:false,
			url:"{:U('u/Index/buyorder')}",
			error:
			function(request)  {
	            showerrormsg('网络错误', 100, 1000);
	            return false;               
	        },
	        success:  
	        function(data){
	        	data=JSON.parse(data.info);
	        	if(data.status==1){
					if(!data){
						showerrormsg('还没购买商品呦！', 100, 1000);
						return;
					}
					$('tbody[addbuy]').html('');
					var _tbody=$('tbody[addbuy]');
					$(data['list']).each(function(i,v){
						 _tbody.append("<tr><td>"+v['Title']+"</td><td>"+v['Price']+"</td><td>"+Gettradewaytxt(v['TradeWay'])+"</td><td><a>"+v['SellNick']+"</a></td><td class='text-orange'>"+Star(v['BuyerStar'])+"</td></tr>");
					});
				}               
	        }
		});
		return true;
	});
	/*发货 收货*/
	$('.sendgoods').click(function(e) {
		if(!confirm('您确定吗？')){
			return;
		}
	    var _id = $(this).attr('nid');
	    var _otype = $(this).attr('otype');
	    $.ajax({
	        type: 'post',
	        cache: false,
	        url: "{:U('u/Index/updateorder')}",
	        data: {
	            OId: _id,
	            OType: _otype
	        },
	        error:  
	        function(request)  {
	            showerrormsg('网络错误', 100, 1000);
	            return false;               
	        },
	        success:  
	        function(data){
	            if (data.status == 0) {
	            	showsuccessmsg(data.info, 100, 1000);
	                location.href = location.href;
	                return false;
	            } else {
		            $('.morder').remove();
	            	showsuccessmsg(data.info, 100, 1000);
	            	$('tbody[addorder]').html('');
					var _tbody=$('tbody[addorder]');
					$(data['list']).each(function(i,v){
						
						 _tbody.append("<tr class='morder'><td></td><td>"+v['Title']+"</td><td>"+v['Price']+"</td><td>"+Gettradewaytxt(v['TradeWay'])+"</td><td>"+v['BuyNick']+":"+v['Tel']+"<br/>"+v['Address']+"</td><td></td></tr>");
					});
	                return false;
	            }                
	        }
	    });
	    return false;
	});
	/* 点击评价后将 订单Id 传个弹出的界面 */
	$('.pingfen').click(function(e) {
		$('#oid').val($(this).attr('nid'));
		$('#otype').val($(this).attr('otype'));
	});
});
</script>
</block>